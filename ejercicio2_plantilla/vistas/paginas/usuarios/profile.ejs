<form id="form-foto-perfil" action="/usuarios/perfil" method="POST">
    <% function mostrarSaludo(session) { %>     
        <div class="saludo">
            <% if (session.login) { %>
                <!-- Foto de perfil seleccionada -->
                <div class = bordefotoperfilmostradausuario id="foto-perfil-seleccionada">
                    <img class = "fotoperfilmostradausuario" src="../img/Perfil<%= session.foto_perfil%>.png" alt="Foto de perfil">
                </div>
                <!-- Texto de bienvenida -->
                <div>
                    <h1>Bienvenid@, <%= session.nombre %></h1>
                    <h1>username: <%= session.username %></h1>
                    <p><strong>Rol:</strong> <%= session.rol === 'A' ? 'Administrador' : 'Usuario' %></p>
                </div>
                <!-- Campos ocultos para enviar automáticamente el username y la foto_perfil -->
                <input type="hidden" name="username" value="<%= session.username %>">
                <input type="hidden" id="foto-perfil-input" name="foto_perfil" value="<%= session.foto_perfil %>">
                <input type="hidden" id="darse_de_baja_input" name="darse_de_baja" value="<%= session.darse_de_baja %>">
            <% } else { %>
                <p>Usuario desconocido. <a href='/usuarios/login'>Login</a></p>
            <% } %>
        </div>

        <% if (session.login) { %>
            <div class = "organizacionusuario">
                <p>📸 Selecciona tu foto de perfil:</p>
                <div class="panelfotopefilusuario">
                    <button class = botonfotoperfilusuario type="button" onclick="seleccionarFoto('Perfil1.png')">
                        <img class = fotoperfilaelegirusuario src="../img/Perfil1.png" width="120" alt="Ícono de enlace">
                    </button>
                    <button class = botonfotoperfilusuario type="button" onclick="seleccionarFoto('Perfil2.png')">
                        <img class = fotoperfilaelegirusuario src="../img/Perfil2.png" width="120" alt="Ícono de enlace" >
                    </button>
                    <button class = botonfotoperfilusuario type="button" onclick="seleccionarFoto('Perfil3.png')">
                        <img class = fotoperfilaelegirusuario src="../img/Perfil3.png" width="120" alt="Ícono de enlace" >
                    </button>
                    <button class = botonfotoperfilusuario type="button" onclick="seleccionarFoto('Perfil4.png')">
                        <img class = fotoperfilaelegirusuario src="../img/Perfil4.png" width="120" alt="Ícono de enlace">
                    </button>
                    <button class = botonfotoperfilusuario type="button" onclick="seleccionarFoto('Perfil5.png')">
                        <img class = fotoperfilaelegirusuario src="../img/Perfil5.png" width="120" alt="Ícono de enlace">
                    </button>
                </div>
                <p id="foto-seleccionada"></p>
            </div>

            <!-- Botón para enviar el formulario -->
        <div class="botonusuario">
            <button class = "botonusuariofotoperfil" type="submit">
                Guardar cambios en foto de perfil
            </button>

            <!-- Botón para darse de baja -->
            <button class = "botonusuariodarsedebaja" type="button" onclick="darseDeBaja()">
                Darse de baja
            </button>
        </div>
        <% } %>
    </form>

    <script>
        function darseDeBaja() {
            // Confirmar la acción
            if (confirm('¿Estás seguro de que deseas darte de baja? Esta acción no se puede deshacer.')) {
                // Enviar una solicitud POST al backend
                fetch('/usuarios/darseDeBaja', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username: '<%= session.username %>' }) // Enviar el username si es necesario
                })
                .then(response => {
                    console.log(response.stringify());
                    if (response.ok) {
                        alert('Tu cuenta ha sido eliminada.');
                        window.location.href = '/usuarios/logout'; // Redirigir al logout
                    } else {
                        alert('Hubo un problema al intentar darte de baja.');
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        }
    </script>

    <script>
        function seleccionarFoto(foto) {
           
            // Extraer el número de la foto del nombre del archivo ("Perfil1.png" -> "1")
            const numeroPerfil = foto.match(/\d+/)[0];

            // Actualizar el campo oculto con el número de la foto seleccionada
            document.getElementById('foto-perfil-input').value = numeroPerfil;

            // Mostrar un mensaje indicando la selección
            document.getElementById('foto-seleccionada').innerText = `Has seleccionado Perfil ${numeroPerfil}`;
        }
    </script>
<% } %>
    
<body>
    <!-- Llamada a la función mostrarSaludo -->
    <%= mostrarSaludo(session) %>
</body>